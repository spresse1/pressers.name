<!doctype html><html lang=en><head><title>Booting Windows in both a VM and Bare Metal - The Electronic Press</title><meta charset=utf-8><meta http-equiv=cache-control content="public"><meta name=robots content="follow, all"><meta name=language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="So. My laptop primarily runs linux. However, I&rsquo;ve got a few reasons to run Windows - gaming being one of them, watching streaming SilverLight video (choughnetflixcough) another. Rebooting a machine every time I want to switch operating systems is rather a drag. However, for some things (gaming), I&rsquo;ll want to be doing this anyway. So I figured out how to make Windows both bare-metal boot and VM boot. I make no guarantees about any sort of performance."><meta name=keywords content><link rel=alternate type=application/rss+xml title="RSS Feed for pressers.name" href=/index.xml><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/base.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/cssmenu.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/menustyling.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/blog.css><link rel=stylesheet type=text/css media=print href=/static/css/print.css></head><body><div id=skip><a href=#content>Skip to Main Content</a></div><div id=leftbar></div><div id=contentwrapper><div id=header><div id=titleimagediv></div><div id=twotraces><div id=twotracesright>&nbsp;</div></div></div><div class=menu id=topmenu><nav><ul class=top-navigation><li><a href=/ title=Home rel=home>Home</a></li><li><a href=http://github.com/spresse1>GitHub</a></li><li><a href=/contact>Contact</a></li></ul></nav></div><div id=onetrace><div id=onetraceleft></div><div id=breadcrumbs class=breadcrumbs><nav><ul class=breadcrumbs><li><a href=/>Home</a></li><li><a href=/blog/>Blogs</a></li><li><a href=/2013/01/07/booting-windows-both-vm-and-bare-metal/>Booting Windows in both a VM and Bare Metal</a></li></ul></nav></div></div><div id=bodywrapper><div id=content><div id=contentborder></div><div id=innercontent><main><div class=hentry><article itemtype=http://schema.org/Article itemscope id=blog/booting-windows-both-vm-and-bare-metal.md><header class=entry-header><h1 class=entry-title><a href=/2013/01/07/booting-windows-both-vm-and-bare-metal/>Booting Windows in both a VM and Bare Metal</a></h1><p class=entry-info>Published on <time>Mon, Jan 7, 2013</time></p></header><div class=entry-body><p>So.  My laptop primarily runs linux.  However, I&rsquo;ve got a few reasons to run Windows - gaming being one of them, watching streaming SilverLight video (<em>chough</em>netflix<em>cough</em>) another.  Rebooting a machine every time I want to switch operating systems is rather a drag.  However, for some things (gaming), I&rsquo;ll want to be doing this anyway.  So I figured out how to make Windows both bare-metal boot and VM boot.  I make no guarantees about any sort of performance.</p><p>As a side note, I&rsquo;ll probably also play with enabling the Optimus video card on my laptop for the VM.  Letting the video-intensive VM have basically a video card all to itself ought to help performance&mldr;.</p><p>Anyway, on to the setup.</p><h1 id=my-setupthings-you-need>My Setup/Things you Need</h1><ul><li>VirtualBox</li><li>Windows 8</li><li>Windows Install DVD/DVD Image</li></ul><h1 id=procedure>Procedure</h1><h2 id=prerequisite-bare-metal-dual-boot>Prerequisite: Bare-Metal Dual-Boot</h2><p>As it says.  I&rsquo;m assuming here that your machine is already set up and properly dual booting.</p><h2 id=give-your-user-raw-disk-access>Give Your User Raw Disk Access</h2><p>Linux really doesn&rsquo;t like users having raw disk access.  However, it is possible.  On my debian system, a simple look at the disks in /dev reveals how:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ls -l /dev/sd*
</span></span><span style=display:flex><span>brw-rw---T <span style=color:#ae81ff>1</span> root disk 8, <span style=color:#ae81ff>0</span> Jan  <span style=color:#ae81ff>6</span> 22:12 /dev/sda
</span></span></code></pre></div><p>By adding our user to the disk group, they&rsquo;ll be able to have raw disk access.  So lets do that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># usermod -aG disk [username]</span>
</span></span></code></pre></div><p>In my case, the simplest way to have this take effect was a reboot.  It certainly didn&rsquo;t take effect while I was still logged in.  If you run into errors later, don&rsquo;t be afraid to reboot.  It may actually solve something.</p><h2 id=copy-your-mbr>Copy Your MBR</h2><p>We&rsquo;re going to be altering the bootloader on the disk in order to make this work.  The bootloader is the program that bootstraps the operating system up.  Mess up the bootloader and you&rsquo;ll need a rescue disk to get the operating system running again.  The bootloader lives in the first 512 bytes of the hard disk, along with the partition table.  We want both of these.  Here is how to copy them to a file on debian:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/<span style=color:#f92672>[</span>diskname<span style=color:#f92672>]</span> of<span style=color:#f92672>=[</span>filename<span style=color:#f92672>]</span>.mbr bs<span style=color:#f92672>=</span><span style=color:#ae81ff>512</span> count<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>1+0 records in
</span></span><span style=display:flex><span>1+0 records out
</span></span><span style=display:flex><span><span style=color:#ae81ff>512</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>512</span> B<span style=color:#f92672>)</span> copied, 6.6136e-05 s, 7.7 MB/s
</span></span></code></pre></div><h2 id=give-virtualbox-raw-disk-access>Give VirtualBox Raw Disk Access</h2><p>For this step, you&rsquo;ll need to know the number of the partition you installed Windows on.  If you don&rsquo;t, this command should help:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ VBoxManage internalcommands listpartitions -rawdisk /dev/<span style=color:#f92672>[</span>diskname<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>NTFS (which most modern Windows systems use) is partition type 0x07.  Now, lets create a virtual hard disk which has access to ONLY the windows partition.  We want to give it access to only the windows partition so we cannot accidentally try to boot Linux from in Linux - that would seriously mess up your filesystem.  Without further ado, here is the relevant command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ VBoxManage internalcommands createrawvmdk -filename <span style=color:#f92672>[</span>Virtual Disk<span style=color:#f92672>]</span>.vmdk -rawdisk /dev/<span style=color:#f92672>[</span>diskname<span style=color:#f92672>]</span> -partitions <span style=color:#f92672>[</span>NTFS Partitions<span style=color:#f92672>]</span> -mbr <span style=color:#f92672>[</span>MBR file<span style=color:#f92672>]</span>.mbr
</span></span></code></pre></div><p>Make sure you&rsquo;re using the full disk name - /dev/sda, for example.  See <a href=http://www.virtualbox.org/manual/ch09.html>this page</a> for more details and documentation.</p><p>There will likly be more than one NTFS partition.  List all of them, separated by commas.  (Typically one is the boot partition, while the other contains the full OS)</p><h2 id=set-up-vm>Set Up VM</h2><p>Next, set up the VM.  Tell it to use an existing hard disk - the one we created earlier.</p><p>You&rsquo;ll also need to mount your Windows install/repair DVD on the VM for the first startup.</p><h2 id=boot-vm-to-installrepair-disk>Boot VM to Install/Repair Disk</h2><p>On Windows 8 this really only means starting the VM and then pressing a key when asked to.</p><h2 id=repair-the-boot-record>&lsquo;Repair&rsquo; the Boot Record</h2><p>Follow the directions on <a href=http://windows8themes.org/repair-fix-mbr-in-windows-8-using-the-command-prompt.html>this page</a> to reinstall the Windows bootloader.</p><h2 id=reboot>Reboot</h2><p>Now, reboot the VM.  This time, don&rsquo;t go to the install/repair DVD, let it boot all the way up.  If all has gone well, you will boot straight into Windows.</p><h1 id=words-of-warning>Words of Warning</h1><p>If you adjust your partition table, you&rsquo;ll almost certainly screw everything on your Windows partition up if you don&rsquo;t recopy the MBR.  Windows (bare metal) will think the partition is one size while Windows (VM) will think it is another.  The way to work around this is to recopy the partition table to your MBR file after adjusting the real MBR.  Basically, this entails repeating these steps from &ldquo;Copy Your MBR&rdquo; onwards.  Also, skip &ldquo;Give VirtualBox Raw Disk Access&rdquo;.  This should copy the new partition table, then re-install the Windows bootloader. </p><p>If that doesn&rsquo;t work, just remove the VM and all of its disks and start this over from the beginning.</p></div></article></div></main></div></div><div id=sidebar><div class=widget><nav><h1>Recent Posts</h1><ul class=entries-reent><li><a href=/2022/04/03/website-hosting-changed/>Website hosting changed</a></li><li><a href=/2022/02/01/enigma-2022/>Enigma 2022</a></li><li><a href=/2021/11/21/getting-new-lenses-lensfun-notes/>Getting new lenses for Lensfun</a></li><li><a href=/2021/10/04/living-germany-converting-drivers-license/>Living in Germany: Converting a Driver's License</a></li><li><a href=/2021/02/08/im-moving-germany/>I'm moving to Germany!</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Social Media</h1><ul class=socialmedia><li><a href=https://twitter.com/spresser>Twitter</a></li><li><a href=https://www.linkedin.com/in/steven-presser/>LinkedIn</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Categories</h1><ul class=categories><li><a href=/categories/3d-printing/>3D Printing</a></li><li><a href=/categories/acm/>ACM</a></li><li><a href=/categories/acm-cluster/>ACM Cluster</a></li><li><a href=/categories/cyberlaw/>Cyberlaw</a></li><li><a href=/categories/cybersecurity/>Cybersecurity</a></li><li><a href=/categories/germany/>Germany</a></li><li><a href=/categories/infrastructure/>Infrastructure</a></li><li><a href=/categories/life-in-germany/>Life in Germany</a></li><li><a href=/categories/links/>Links</a></li><li><a href=/categories/presentations/>Presentations</a></li><li><a href=/categories/projects/>Projects</a></li><li><a href=/categories/shrubbery/>Shrubbery</a></li></ul></nav></div><div class=sidebarbender></div></div></div><div id=onetracebottom><footer><a href=https://github.com/spresse1/pressers.name>Website source</a><br>Site design by Kyle M.</footer></div></div></body></html>