<!doctype html><html lang=en><head><title>Building the ACM Cluster, Part 11g: OpenAFS RPM Build - The Electronic Press</title><meta charset=utf-8><meta http-equiv=cache-control content="public"><meta name=robots content="follow, all"><meta name=language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="OpenAFS is the open source version of the AFS - a file system developed at Carnegie-Mellon University. AFS has a global, DNS-based address space. It also has a ton of nice features with respect to allowing users to create and control their own groups and much more granular permissions. All in all it seems to be a good way to get data into a cluster and to allow users to store and manage documents in a reliable format."><meta name=keywords content><link rel=alternate type=application/rss+xml title="RSS Feed for pressers.name" href=/index.xml><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/base.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/cssmenu.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/menustyling.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/blog.css><link rel=stylesheet type=text/css media=print href=/static/css/print.css></head><body><div id=skip><a href=#content>Skip to Main Content</a></div><div id=leftbar></div><div id=contentwrapper><div id=header><div id=titleimagediv></div><div id=twotraces><div id=twotracesright>&nbsp;</div></div></div><div class=menu id=topmenu><nav><ul class=top-navigation><li><a href=/ title=Home rel=home>Home</a></li><li><a href=http://github.com/spresse1>GitHub</a></li><li><a href=/contact>Contact</a></li></ul></nav></div><div id=onetrace><div id=onetraceleft></div><div id=breadcrumbs class=breadcrumbs><nav><ul class=breadcrumbs><li><a href=/>Home</a></li><li><a href=/blog/>Blogs</a></li><li><a href=/2012/12/17/building-acm-cluster-part-11f-openafs-rpm-build/>Building the ACM Cluster, Part 11g: OpenAFS RPM Build</a></li></ul></nav></div></div><div id=bodywrapper><div id=content><div id=contentborder></div><div id=innercontent><main><div class=hentry><article itemtype=http://schema.org/Article itemscope id=blog/acm-cluster/building-acm-cluster-11g.md><header class=entry-header><h1 class=entry-title><a href=/2012/12/17/building-acm-cluster-part-11f-openafs-rpm-build/>Building the ACM Cluster, Part 11g: OpenAFS RPM Build</a></h1><p class=entry-info>Published on <time>Mon, Dec 17, 2012</time>
in ACM, ACM Cluster</p></header><div class=entry-body><p><a href=http://www.openafs.org/>OpenAFS</a> is the open source version of the AFS - a file system developed at Carnegie-Mellon University.  AFS has a global, DNS-based address space.  It also has a ton of nice features with respect to allowing users to create and control their own groups and much more granular permissions.  All in all it seems to be a good way to get data into a cluster and to allow users to store and manage documents in a reliable format.</p><h1 id=building-openafs>Building OpenAFS</h1><p>I&rsquo;ve saved building OpenAFS for last because it is somewhat more complicated than the other RPM builds we&rsquo;ve done so far, primarily due to some messiness with kernel versions.  Spcifically, the kernel interfaces that OpenAFS-1.6.1 (the current Linux release) were changed from the 2.6 to the 3.x branch.  OpenAFS has sources that are patched for this, but hasn&rsquo;t released them yet.</p><h2 id=getting-source>Getting Source</h2><p>So, to get the proper source, we&rsquo;re going to have to get them from git.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ git clone git://git.openafs.org/openafs.git
</span></span></code></pre></div><p>We then want to advance to the current HEAD revision of the branch named &ldquo;openafs-stable-1_6_x&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd openafs <span style=color:#f92672>&amp;&amp;</span> git checkout openafs-stable-1_6_x
</span></span></code></pre></div><p>Finally, you&rsquo;ll want the OpenAFS <a href=http://www.openafs.org/release/latest.html>docs tar.bz2, available here</a>.  At the time of writing this is <a href=http://www.openafs.org/dl/openafs/1.6.1/openafs-1.6.1-doc.tar.bz2>openafs-1.6.1-doc.tar.bz2</a>.</p><h2 id=building-source>Building Source</h2><p>First things first - we need to regenerate the source tree to reflect the fast that it has moved machines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./regen.sh
</span></span></code></pre></div><p>Now comes some of the tough part - we&rsquo;re going to work through the packaging scripts OpenAFS uses to build RedHat RPMs (they happen to work on CentOS too).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd src/packaging/RedHat/
</span></span></code></pre></div><p>The next step is to build a source RPM.  This is an RPM designed to enable the building of a binary RPM.  OpenAFS provides a script for doing this - makesrpm.pl - but it requires two tarballs - one of the source and one of the docs.  We have one of the docs (we downloaded it earlier, remember?), so lets build one of the source.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd ~
</span></span></code></pre></div><p>We need to fake the entire structure of the OpenAFS source tarball.  This means our source folder needs to be named openafs-1.6.1</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ mv openafs openafs-1.6.1
</span></span></code></pre></div><p>Now we have to create some files in the tarball (and remove all the git history, while we&rsquo;re at it&mldr;)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;1.6.1&#34;</span> &gt; openafs-1.6.1/.version
</span></span><span style=display:flex><span>$ rm -rf openafs-1.6.1/.git&lt;
</span></span></code></pre></div><p>Now, lets actually create our tarball.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ tar cjf openafs-1.6.1-src.tar.bz2
</span></span></code></pre></div><p>Now comes the tough part.  We have to use the RedHat scripts OpenAFS provides to build a source RPM.  the SRPM can then be used to build a binary RPM.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd openafs-1.6.1/src/packaging/RedHat/
</span></span><span style=display:flex><span>$ ./makesrpm.pl ~/openafs-1.6.1-src.tar.bz2 ~/openafs-1.6.1-doc.tar.bz2
</span></span></code></pre></div><p>(I&rsquo;ve assumed you but both tarballs in your home directory.  If not, adjust the paths.)  This will spit out a file named <code>openafs-1.6.1-1.src.rpm</code>.  We can now use this to build the binary packages with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ rpmbuild --rebuild openafs-1.6.1-1.src.rpm
</span></span></code></pre></div><p>This will likely require some dependencies, use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># yum install -y `rpmbuild --rebuild openafs-1.6.1-1.src.rpm 2&gt;&amp;1 | grep &#39;is needed by&#39;`</span>
</span></span></code></pre></div><p>to install them.</p><p>The build will chew for a while, then spit out binary packages.  Copy these to your management node and <a href=/2012/12/15/building-acm-cluster-part-11b-kernel-rpm-build/>inject them as before</a>.  Congratulations, you just built OpenAFS!</p></div></article></div></main></div></div><div id=sidebar><div class=widget><nav><h1>Recent Posts</h1><ul class=entries-reent><li><a href=https://pressers.name/2022/02/01/enigma-2022/>Enigma 2022</a></li><li><a href=https://pressers.name/2021/11/21/getting-new-lenses-lensfun-notes/>Getting new lenses for Lensfun</a></li><li><a href=https://pressers.name/2021/10/04/living-germany-converting-drivers-license/>Living in Germany: Converting a Driver's License</a></li><li><a href=https://pressers.name/2021/02/08/im-moving-germany/>I'm moving to Germany!</a></li><li><a href=https://pressers.name/2021/01/23/i-finally-finished-kings-quest-6/>I Finally Finished King's Quest 6!</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Social Media</h1><ul class=socialmedia><li><a href=https://twitter.com/spresser>Twitter</a></li><li><a href=https://www.linkedin.com/in/steven-presser/>LinkedIn</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Categories</h1><ul class=categories><li><a href=https://pressers.name/categories/3d-printing/>3D Printing</a></li><li><a href=https://pressers.name/categories/acm/>ACM</a></li><li><a href=https://pressers.name/categories/acm-cluster/>ACM Cluster</a></li><li><a href=https://pressers.name/categories/cyberlaw/>Cyberlaw</a></li><li><a href=https://pressers.name/categories/cybersecurity/>Cybersecurity</a></li><li><a href=https://pressers.name/categories/germany/>Germany</a></li><li><a href=https://pressers.name/categories/infrastructure/>Infrastructure</a></li><li><a href=https://pressers.name/categories/life-in-germany/>Life in Germany</a></li><li><a href=https://pressers.name/categories/links/>Links</a></li><li><a href=https://pressers.name/categories/presentations/>Presentations</a></li><li><a href=https://pressers.name/categories/projects/>Projects</a></li><li><a href=https://pressers.name/categories/shrubbery/>Shrubbery</a></li></ul></nav></div><div class=sidebarbender></div></div></div><div id=onetracebottom><footer><a href=https://github.com/spresse1/pressers.name>Website source</a><br>Site design by Kyle M.</footer></div></div></body></html>