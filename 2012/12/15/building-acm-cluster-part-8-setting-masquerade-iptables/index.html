<!doctype html><html lang=en><head><title>Building the ACM Cluster, Part 9: Setting up masquerade with iptables - The Electronic Press</title><meta charset=utf-8><meta http-equiv=cache-control content="public"><meta name=robots content="follow, all"><meta name=language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Alright! Lets get this started again. There is one last thing we need to do in order to have networking on the cluster functional. Right now, the nodes inside the cluster can&rsquo;t speak to the outside world. While we set up the head node to be able to speak to things on every interface, we haven&rsquo;t yet told it how to move traffic from one interface to another.
Making the Gateway In normal clusters, there are three types of notes - workers, gateways and head nodes."><meta name=keywords content><link rel=alternate type=application/rss+xml title="RSS Feed for pressers.name" href=/index.xml><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/base.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/cssmenu.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/menustyling.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/blog.css><link rel=stylesheet type=text/css media=print href=/static/css/print.css></head><body><div id=skip><a href=#content>Skip to Main Content</a></div><div id=leftbar></div><div id=contentwrapper><div id=header><div id=titleimagediv></div><div id=twotraces><div id=twotracesright>&nbsp;</div></div></div><div class=menu id=topmenu><nav><ul class=top-navigation><li><a href=/ title=Home rel=home>Home</a></li><li><a href=http://github.com/spresse1>GitHub</a></li><li><a href=/contact>Contact</a></li></ul></nav></div><div id=onetrace><div id=onetraceleft></div><div id=breadcrumbs class=breadcrumbs><nav><ul class=breadcrumbs><li><a href=/>Home</a></li><li><a href=/blog/>Blogs</a></li><li><a href=/2012/12/15/building-acm-cluster-part-8-setting-masquerade-iptables/>Building the ACM Cluster, Part 9: Setting up masquerade with iptables</a></li></ul></nav></div></div><div id=bodywrapper><div id=content><div id=contentborder></div><div id=innercontent><main><div class=hentry><article itemtype=http://schema.org/Article itemscope id=blog/acm-cluster/building-acm-cluster-part-8-setting-masquerade-iptables.md><header class=entry-header><h1 class=entry-title><a href=/2012/12/15/building-acm-cluster-part-8-setting-masquerade-iptables/>Building the ACM Cluster, Part 9: Setting up masquerade with iptables</a></h1><p class=entry-info>Published on <time>Sat, Dec 15, 2012</time>
in ACM, ACM Cluster</p></header><div class=entry-body><p>Alright! Lets get this started again.  There is one last thing we need to do in order to have networking on the cluster functional.  Right now, the nodes inside the cluster can&rsquo;t speak to the outside world.  While we set up the head node to be able to speak to things on every interface, we haven&rsquo;t yet told it how to move traffic from one interface to another.</p><h1 id=making-the-gateway>Making the Gateway</h1><p>In normal clusters, there are three types of notes - workers, gateways and head nodes.  Workers do whatever task the cluster is intended for.  Head noes manage the workers.  And finally, gateways, which allow the worker nodes to communicate with things outside the cluster.</p><p>Gateways are needed because clusters often use IP addresses which are not publicly routeable.  The gateway allows the entire cluster to sit behind one IP address and is in charge of routing traffic properly.  This process is called <a href=http://en.wikipedia.org/wiki/Network_address_translation>Network Address Translation</a>.  In many ways, this makes the gateway like your home router.</p><p>Anyway, we&rsquo;re going to be using iptables to implement NAT.  Fortunately, this is a cmmon use for iptables, so it is very simple to set up.  Simply type the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># iptables --table nat --append POSTROUTING --out-interface bond0.2 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e># iptables --table nat --append POSTROUTING --out-interface bond0.3 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e># iptables --append FORWARD --in-interface bond0.def -j ACCEPT</span>
</span></span></code></pre></div><p>and check that it took.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># iptables -L -t nat&lt;</span>
</span></span></code></pre></div><p>You should see something like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Chain PREROUTING <span style=color:#f92672>(</span>policy ACCEPT<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>target     prot opt source               destination         
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Chain POSTROUTING <span style=color:#f92672>(</span>policy ACCEPT<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>target     prot opt source               destination         
</span></span><span style=display:flex><span>MASQUERADE  all  --  anywhere             anywhere            
</span></span><span style=display:flex><span>MASQUERADE  all  --  anywhere             anywhere            
</span></span><span style=display:flex><span>MASQUERADE  all  --  anywhere             anywhere            
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Chain OUTPUT <span style=color:#f92672>(</span>policy ACCEPT<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>target     prot opt source               destination         
</span></span></code></pre></div><p>Finally, we need to save these setting so they get recalled on the next boot.  On a CentOS machine this is trivially simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># service iptables save</span>
</span></span></code></pre></div><p>And done.  That was nice and simple.</p></div></article></div></main></div></div><div id=sidebar><div class=widget><nav><h1>Recent Posts</h1><ul class=entries-reent><li><a href=https://pressers.name/2022/02/01/enigma-2022/>Enigma 2022</a></li><li><a href=https://pressers.name/2021/11/21/getting-new-lenses-lensfun-notes/>Getting new lenses for Lensfun</a></li><li><a href=https://pressers.name/2021/10/04/living-germany-converting-drivers-license/>Living in Germany: Converting a Driver's License</a></li><li><a href=https://pressers.name/2021/02/08/im-moving-germany/>I'm moving to Germany!</a></li><li><a href=https://pressers.name/2021/01/23/i-finally-finished-kings-quest-6/>I Finally Finished King's Quest 6!</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Social Media</h1><ul class=socialmedia><li><a href=https://twitter.com/spresser>Twitter</a></li><li><a href=https://www.linkedin.com/in/steven-presser/>LinkedIn</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Categories</h1><ul class=categories><li><a href=https://pressers.name/categories/3d-printing/>3D Printing</a></li><li><a href=https://pressers.name/categories/acm/>ACM</a></li><li><a href=https://pressers.name/categories/acm-cluster/>ACM Cluster</a></li><li><a href=https://pressers.name/categories/cyberlaw/>Cyberlaw</a></li><li><a href=https://pressers.name/categories/cybersecurity/>Cybersecurity</a></li><li><a href=https://pressers.name/categories/germany/>Germany</a></li><li><a href=https://pressers.name/categories/infrastructure/>Infrastructure</a></li><li><a href=https://pressers.name/categories/life-in-germany/>Life in Germany</a></li><li><a href=https://pressers.name/categories/links/>Links</a></li><li><a href=https://pressers.name/categories/presentations/>Presentations</a></li><li><a href=https://pressers.name/categories/projects/>Projects</a></li><li><a href=https://pressers.name/categories/shrubbery/>Shrubbery</a></li></ul></nav></div><div class=sidebarbender></div></div></div><div id=onetracebottom><footer><a href=https://github.com/spresse1/pressers.name>Website source</a><br>Site design by Kyle M.</footer></div></div></body></html>