<!doctype html><html lang=en><head><title>Building the ACM Cluster, Part 11b: Kernel RPM Build - The Electronic Press</title><meta charset=utf-8><meta http-equiv=cache-control content="public"><meta name=robots content="follow, all"><meta name=language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="If you haven&rsquo;t already done so, read and execute Building the ACM Cluster, Part 11a: Setting up rpmbuild environment.
This article will be covering building a new kernel for CentOS and injecting it into xCat&rsquo;s local package repository. I am covering this because later on we&rsquo;ll need to have a more recent kernel than CentOS comes with by default. Xen specifically requires a later kernel. However, when we build kernel modules, we&rsquo;ll want to be building against the same kernel version we&rsquo;re running."><meta name=keywords content><link rel=alternate type=application/rss+xml title="RSS Feed for pressers.name" href=/index.xml><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/base.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/cssmenu.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/menustyling.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/blog.css><link rel=stylesheet type=text/css media=print href=/static/css/print.css></head><body><div id=skip><a href=#content>Skip to Main Content</a></div><div id=leftbar></div><div id=contentwrapper><div id=header><div id=titleimagediv></div><div id=twotraces><div id=twotracesright>&nbsp;</div></div></div><div class=menu id=topmenu><nav><ul class=top-navigation><li><a href=/ title=Home rel=home>Home</a></li><li><a href=http://github.com/spresse1>GitHub</a></li><li><a href=/contact>Contact</a></li></ul></nav></div><div id=onetrace><div id=onetraceleft></div><div id=breadcrumbs class=breadcrumbs><nav><ul class=breadcrumbs><li><a href=/>Home</a></li><li><a href=/blog/>Blogs</a></li><li><a href=/2012/12/16/building-acm-cluster-part-11b-kernel-rpm-build/>Building the ACM Cluster, Part 11b: Kernel RPM Build</a></li></ul></nav></div></div><div id=bodywrapper><div id=content><div id=contentborder></div><div id=innercontent><main><div class=hentry><article itemtype=http://schema.org/Article itemscope id=blog/acm-cluster/building-acm-cluster-part-11b-kernel-rpm-build.md><header class=entry-header><h1 class=entry-title><a href=/2012/12/16/building-acm-cluster-part-11b-kernel-rpm-build/>Building the ACM Cluster, Part 11b: Kernel RPM Build</a></h1><p class=entry-info>Published on <time>Sun, Dec 16, 2012</time>
in ACM, ACM Cluster</p></header><div class=entry-body><p>If you haven&rsquo;t already done so, read and execute <a href=/2012/12/15/building-acm-cluster-part-11a-setting-rpmbuild-environment/>Building the ACM Cluster, Part 11a: Setting up rpmbuild environment</a>.</p><p>This article will be covering building a new kernel for CentOS and injecting it into xCat&rsquo;s local package repository.  I am covering this because later on we&rsquo;ll need to have a more recent kernel than CentOS comes with by default.  Xen specifically requires a later kernel.  However, when we build kernel modules, we&rsquo;ll want to be building against the same kernel version we&rsquo;re running.</p><h1 id=kernel-spec>Kernel Spec</h1><p>I&rsquo;ve built a kernel spec based on that at ElRepo (downloadable at <code>kernel/el6/SPECS/</code> from any of <a href=http://elrepo.org/tiki/Download>these mirrors</a>).  This builds a kernel package called kernel-ml.  This is so that it can coexist with the CentOS official kernel.  However, I have a different goal - I want to replace the kernel.  I&rsquo;ve therefore created my own <a href=https://github.com/spresse1/acm-vm-cluster/blob/master/kernel/kernel-3.6.spec>branch on my GitHub</a>.  The only difference between this and the official specfile is that I&rsquo;ve removed every instance of -ml so that the built RPM will replace the official kernel.  Copy this specfile into your rpmbuild/SPECS directory.</p><p>Now we need to acquire the linux source in .tar.bz2 form.  It is available from <a href=http://www.kernel.org/pub/linux/kernel/>kernel.org</a>.  You can download any 3.6 kernel you wish.  My spec file is (at the time of writing) set for kernel 3.6.9.  If you wish to use a more recent kernel, there is a single line near the top to update.  Once you&rsquo;ve downloaded your kernel of choice, put it in <code>rpmbuild/SOURCES</code>.  </p><p>Finally, you need configuration files for the kernel.  You can do one of two things - use <a href=https://github.com/spresse1/acm-vm-cluster/blob/master/kernel/config-3.6.9>my configuration file</a> or build your own.  If you build your own, I recommend that you untar the source you downloaded and configure that, then copy the generated <code>.config</code>.  Whatever configuration file you use, it needs to be copied into 4 places - </p><ul><li><code>rpmbuild/SOURCES/config-[KERNEL_VERSION]-i686</code></li><li><code>rpmbuild/SOURCES/config-[KERNEL_VERSION]-i686-NONPAE</code></li><li><code>rpmbuild/SOURCES/config-[KERNEL_VERSION]-x86_64</code></li><li><code>rpmbuild/SOURCES/config-[KERNEL_VERSION]-x86_64-NONPAE</code></li></ul><p>These files may all be the same configuration.  Once you have these in place, you&rsquo;re ready to build!</p><h1 id=building-the-kernel>Building the Kernel</h1><p>Having a spec file makes building the kernel nice and easy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ rpmbuild -ba rpmbuild/SPECS/kernel-3.6.spec
</span></span></code></pre></div><p>Your computer will spin for a while, then the built RPM will appear in <code>rpmbuild/RPMS</code>.</p><h1 id=injecting-the-kernel>Injecting the Kernel</h1><p>Although I&rsquo;m discussing this process specific to the kernel, it is actually the same for any package you want to inject into your local xCat repository.  We&rsquo;ll be referring to this procedure in future package injections.</p><p>First things first - you have to do this on your management node.  So copy the RPMs from the machine you built them on to your management node.  xCat keeps its RPMs in two places for CentOS - <code>/install/[OS_VERSION]/x86_64/repodata</code> and <code>/install/[OS_VERSION]/x86_64/x86_64/repodata</code>, where OS_VERSION is something like centos6.3  So copy your RPM to both of these locations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># cp [PACKAGE] /install/[OS_VERSION]/x86_64/Packages</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cp [PACKAGE] /install/[OS_VERSION]/x86_64/x86_64/Packages</span>
</span></span></code></pre></div><p>Now that we have the files in the right place, we need to rebuild the repository.  The tool we use to do this is called, obviously enough, createrepo.  So run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># createrepo -g /install/centos6.3/x86_64/repodata/*-x86_64-comps.xml /install/centos6.3/x86_64/</span>
</span></span></code></pre></div><p>The <code>-g</code> option preserves the groups that are already in the repository.</p><p>And you now have built your own kernel and injected it into the repository.  From here I suggest reinstalling a node, so you can do future RPM builds on a node running your new kernel.</p></div></article></div></main></div></div><div id=sidebar><div class=widget><nav><h1>Recent Posts</h1><ul class=entries-reent><li><a href=/2022/04/03/website-hosting-changed/>Website hosting changed</a></li><li><a href=/2022/02/01/enigma-2022/>Enigma 2022</a></li><li><a href=/2021/11/21/getting-new-lenses-lensfun-notes/>Getting new lenses for Lensfun</a></li><li><a href=/2021/10/04/living-germany-converting-drivers-license/>Living in Germany: Converting a Driver's License</a></li><li><a href=/2021/02/08/im-moving-germany/>I'm moving to Germany!</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Social Media</h1><ul class=socialmedia><li><a href=https://twitter.com/spresser>Twitter</a></li><li><a href=https://www.linkedin.com/in/steven-presser/>LinkedIn</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Categories</h1><ul class=categories><li><a href=/categories/3d-printing/>3D Printing</a></li><li><a href=/categories/acm/>ACM</a></li><li><a href=/categories/acm-cluster/>ACM Cluster</a></li><li><a href=/categories/cyberlaw/>Cyberlaw</a></li><li><a href=/categories/cybersecurity/>Cybersecurity</a></li><li><a href=/categories/germany/>Germany</a></li><li><a href=/categories/infrastructure/>Infrastructure</a></li><li><a href=/categories/life-in-germany/>Life in Germany</a></li><li><a href=/categories/links/>Links</a></li><li><a href=/categories/presentations/>Presentations</a></li><li><a href=/categories/projects/>Projects</a></li><li><a href=/categories/shrubbery/>Shrubbery</a></li></ul></nav></div><div class=sidebarbender></div></div></div><div id=onetracebottom><footer><a href=https://github.com/spresse1/pressers.name>Website source</a><br>Site design by Kyle M.</footer></div></div></body></html>