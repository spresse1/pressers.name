<!doctype html><html lang=en><head><title>Building the ACM Cluster, Part 8: Adventures in Routing: Source Based (Multi-homed) Routing - The Electronic Press</title><meta charset=utf-8><meta http-equiv=cache-control content="public"><meta name=robots content="follow, all"><meta name=language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="(This post is related to the ACM cluster build. However, it is really generic systems stuff and not terribly related to the actual cluster build. It is much more closely related to quirks of JHU networking.)
The Problem JHU has two distinct networks - firewalled and firewall-free. (In truth there are more and there are gradations, but these are the two JHUACM has IP allocations on.) Some services cannot be run form inside the firewalled network."><meta name=keywords content><link rel=alternate type=application/rss+xml title="RSS Feed for pressers.name" href=/index.xml><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/base.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/cssmenu.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/menustyling.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/blog.css><link rel=stylesheet type=text/css media=print href=/static/css/print.css></head><body><div id=skip><a href=#content>Skip to Main Content</a></div><div id=leftbar></div><div id=contentwrapper><div id=header><div id=titleimagediv></div><div id=twotraces><div id=twotracesright>&nbsp;</div></div></div><div class=menu id=topmenu><nav><ul class=top-navigation><li><a href=/ title=Home rel=home>Home</a></li><li><a href=http://github.com/spresse1>GitHub</a></li><li><a href=/contact>Contact</a></li></ul></nav></div><div id=onetrace><div id=onetraceleft></div><div id=breadcrumbs class=breadcrumbs><nav><ul class=breadcrumbs><li><a href=/>Home</a></li><li><a href=/blog/>Blogs</a></li><li><a href=/2012/10/17/adventures-routing-source-based-multi-homed-routing/>Building the ACM Cluster, Part 8: Adventures in Routing: Source Based (Multi-homed) Routing</a></li></ul></nav></div></div><div id=bodywrapper><div id=content><div id=contentborder></div><div id=innercontent><main><div class=hentry><article itemtype=http://schema.org/Article itemscope id=blog/acm-cluster/adventures-routing-source-based-multi-homed-routing.md><header class=entry-header><h1 class=entry-title><a href=/2012/10/17/adventures-routing-source-based-multi-homed-routing/>Building the ACM Cluster, Part 8: Adventures in Routing: Source Based (Multi-homed) Routing</a></h1><p class=entry-info>Published on <time>Wed, Oct 17, 2012</time>
in ACM, ACM Cluster</p></header><div class=entry-body><p>(This post is related to the ACM cluster build.  However, it is really generic systems stuff and not terribly related to the actual cluster build.  It is much more closely related to quirks of JHU networking.)</p><h1 id=the-problem>The Problem</h1><p>JHU has two distinct networks - firewalled and firewall-free.  (In truth there are more and there are gradations, but these are the two JHUACM has IP allocations on.)  Some services cannot be run form inside the firewalled network.  For these the ACM has a small firewall-free allocation.  Because the cluster will be hosting VMs inside both networks, it needs to be capable of routing traffic from both.  This means doing something called source-based routing or multihomed routing.  This refers to the fact that this machine will have two connections to the internet.  Typically, this is a very rare setup - Multihoming is usually used at the ISP or datacenter level, rather than at the level of the individual box.</p><h1 id=the-solution>The Solution</h1><p>The solution is to convert linux to source-based routing by manipulation of iproute2.  We can add additional rules and rule tables to intercept traffic and send it out the right interface before falling back to the default route system linux usually uses.  On order to do this, we&rsquo;re going to have to manipulate these files: <code>/etc/iproute2/rt_tables</code>, <code>/etc/sysconfig/network-scripts/route-[ifname]</code>, <code>/etc/sysconfig/network-scripts/rule-[ifname]</code> where <code>[ifname]</code> is the interface name.</p><p>This process takes several steps.  First we need to add new rule tables, then set up per-route interfaces.</p><h2 id=adding-rule-tables>Adding Rule Tables</h2><p>First, lets take a look at <code>/etc/iproute2/rt_tables</code>, which defines the rule tables that iproute2 evaluates.  By default on my CentOS 6.3 machine, it looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># reserved values</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>255	local
</span></span><span style=display:flex><span>254	main
</span></span><span style=display:flex><span>253	default
</span></span><span style=display:flex><span>0	unspec
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># local</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1	inr.ruhep</span>
</span></span></code></pre></div><p>This file is in the format of</p><pre tabindex=0><code>number	name
</code></pre><p>Table numbers are used to assign priority to different tables of routing rules.  Tables with lower numbers are checked first, followed by the higher numbered ones.  Table numbers go up to 255, so the last few are already taken.  We can add tables anywhere in this file and they&rsquo;ll be evaluated in numerical order.  So lets add a couple lines.  In my case I&rsquo;ve added tables for bond0.2 and bond0.3.  You&rsquo;ll want to add one rule for each interface.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>1	source.bond0.2
</span></span><span style=display:flex><span>2	source.bond0.3
</span></span></code></pre></div><p>Your tables can be named whatever you&rsquo;d like.  I prefer explicit naming, so I&rsquo;ve named them to be fairly clear about that.</p><h2 id=setting-up-per-interface-routes>Setting Up Per-Interface Routes</h2><p>There are two steps to this section.  First, we&rsquo;ll set rules for when iproute2 should look at each table.  Then, we&rsquo;ll actually create the routing rules that go in these tables.</p><p>Lets get started with the first step.  In CentOS, we&rsquo;ll edit <code>/etc/sysconfig/network-scripts/rule-[ifname]</code>  in order to say which rules should be applied to the tables (based on which interfaces are up).  Yes this is a little backwards - we apply the rules in tables based on which interfaces are up.  However, this way, we can use the same table over multiple interfaces, reducing the redundancy in configuration.</p><p>Anyway, lets put some rules in <code>/etc/sysconfig/network-scripts/rule-bond0.3</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>from 128.220.70.63 tab source.bond0.3
</span></span></code></pre></div><p>This is actually the entire contents of my <code>rule-bond0.3</code> file.  I&rsquo;ve told iproute2 to apply the table (tab) <code>source.bond0.3</code> to any traffic coming from <code>128.220.70.63</code>.</p><p>Okay, now lets move on and actually put some rules in source.bond0.3.  Edit <code>/etc/sysconfig/network-scripts/rule-bond0.3</code> and insert (the file was previously empty):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>128.220.70.0/24 dev bond0.3 src 128.220.70.63 table source.bond0.3
</span></span><span style=display:flex><span>default via 128.220.70.1 dev bond0.3 table source.bond0.3
</span></span></code></pre></div><p>These are the same rules (and same syntax) you&rsquo;d use with <code>ip route add</code>, just drop the <code>ip route add</code>.  The two rules here are just the basic linux routing rules - send things on my local network directly to the local network and send everything else through a gateway - with the twist that the two of them are in the source.bond0.3 table.  Since this table only gets read for traffic coming from this network, this is effectively a routing table that affects just traffic from this network.  This way, we can have a default route and gateway for each interface, which allows traffic to always leave from the right interface.</p><p>And now these last two steps need to be repeated for each interface you&rsquo;d like involved in source-based routing.</p><h1 id=conclusion>Conclusion</h1><p>While I don&rsquo;t necessarily understand the design decision on the part of linux to not do source-based routing by default, I do appreciate how simple it is to set up with CentOS.  Now that this is set up, I can get started on configuring a NAT for internal traffic - the next (and hopefully final) step in having networking set up for the ACM cluster.</p></div></article></div></main></div></div><div id=sidebar><div class=widget><nav><h1>Recent Posts</h1><ul class=entries-reent><li><a href=/2022/04/03/website-hosting-changed/>Website hosting changed</a></li><li><a href=/2022/02/01/enigma-2022/>Enigma 2022</a></li><li><a href=/2021/11/21/getting-new-lenses-lensfun-notes/>Getting new lenses for Lensfun</a></li><li><a href=/2021/10/04/living-germany-converting-drivers-license/>Living in Germany: Converting a Driver's License</a></li><li><a href=/2021/02/08/im-moving-germany/>I'm moving to Germany!</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Social Media</h1><ul class=socialmedia><li><a href=https://twitter.com/spresser>Twitter</a></li><li><a href=https://www.linkedin.com/in/steven-presser/>LinkedIn</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Categories</h1><ul class=categories><li><a href=/categories/3d-printing/>3D Printing</a></li><li><a href=/categories/acm/>ACM</a></li><li><a href=/categories/acm-cluster/>ACM Cluster</a></li><li><a href=/categories/cyberlaw/>Cyberlaw</a></li><li><a href=/categories/cybersecurity/>Cybersecurity</a></li><li><a href=/categories/germany/>Germany</a></li><li><a href=/categories/infrastructure/>Infrastructure</a></li><li><a href=/categories/life-in-germany/>Life in Germany</a></li><li><a href=/categories/links/>Links</a></li><li><a href=/categories/presentations/>Presentations</a></li><li><a href=/categories/projects/>Projects</a></li><li><a href=/categories/shrubbery/>Shrubbery</a></li></ul></nav></div><div class=sidebarbender></div></div></div><div id=onetracebottom><footer><a href=https://github.com/spresse1/pressers.name>Website source</a><br>Site design by Kyle M.</footer></div></div></body></html>