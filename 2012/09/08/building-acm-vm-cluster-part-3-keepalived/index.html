<!doctype html><html lang=en><head><title>Building the ACM VM Cluster, Part 3: Mangement Node Setup - Keepalived - The Electronic Press</title><meta charset=utf-8><meta http-equiv=cache-control content="public"><meta name=robots content="follow, all"><meta name=language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In part 2 of this series, I covered the network design - the last theoretical piece of design we need. Now let&rsquo;s do some practical stuff! In this section I&rsquo;m going to cover base network setup and keepalived installation on the management node.
Prerequisites For this I&rsquo;ve assumed you already have a set up CentOS machine. In my case, its CentOS 6.3 (64-bit) though this may of course vary, in which case, refer to the XCat documentation to see any differences."><meta name=keywords content><link rel=alternate type=application/rss+xml title="RSS Feed for pressers.name" href=/index.xml><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/base.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/cssmenu.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/menustyling.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/blog.css><link rel=stylesheet type=text/css media=print href=/static/css/print.css></head><body><div id=skip><a href=#content>Skip to Main Content</a></div><div id=leftbar></div><div id=contentwrapper><div id=header><div id=titleimagediv></div><div id=twotraces><div id=twotracesright>&nbsp;</div></div></div><div class=menu id=topmenu><nav><ul class=top-navigation><li><a href=/ title=Home rel=home>Home</a></li><li><a href=http://github.com/spresse1>GitHub</a></li><li><a href=/contact>Contact</a></li></ul></nav></div><div id=onetrace><div id=onetraceleft></div><div id=breadcrumbs class=breadcrumbs><nav><ul class=breadcrumbs><li><a href=/>Home</a></li><li><a href=/blog/>Blogs</a></li><li><a href=/2012/09/08/building-acm-vm-cluster-part-3-keepalived/>Building the ACM VM Cluster, Part 3: Mangement Node Setup - Keepalived</a></li></ul></nav></div></div><div id=bodywrapper><div id=content><div id=contentborder></div><div id=innercontent><main><div class=hentry><article itemtype=http://schema.org/Article itemscope id=blog/acm-cluster/building-acm-vm-cluster-part-3-keepalived.md><header class=entry-header><h1 class=entry-title><a href=/2012/09/08/building-acm-vm-cluster-part-3-keepalived/>Building the ACM VM Cluster, Part 3: Mangement Node Setup - Keepalived</a></h1><p class=entry-info>Published on <time>Sat, Sep 8, 2012</time>
in ACM, ACM Cluster</p></header><div class=entry-body><p>In <a href=/2012/09/08/building-acm-vm-cluster-part-2-network-design/>part 2</a> of this series, I covered the network design - the last theoretical piece of design we need.  Now let&rsquo;s do some practical stuff!  In this section I&rsquo;m going to cover base network setup and keepalived installation on the management node.</p><h1 id=prerequisites>Prerequisites</h1><p>For this I&rsquo;ve assumed you already have a set up CentOS machine.  In my case, its CentOS 6.3 (64-bit) though this may of course vary, in which case, refer to the <a href="http://sourceforge.net/apps/mediawiki/xcat/index.php?title=XCAT_Documentation">XCat documentation</a> to see any differences.</p><h1 id=procedure>Procedure</h1><p>Before we dive into this, lets establish some conventions.  Commands, code, or something you&rsquo;ll see in a system file looks</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Like this.
</span></span></code></pre></div><p>Commands will be prefixed with either $ (for commands you can run as a normal user) or # (for commands to be run as root or with sudo).  I use sane-editor to represent the text-editor of your choice (no flame wars here!)</p><h2 id=onwards-disable-selinux>Onwards! Disable SELinux</h2><p>First, lets disable SELinux (it might step on our toes.  Please feel free to reenable it later if you&rsquo;d like it)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># sane-editor /etc/sysconfig/selinux</span>
</span></span></code></pre></div><p>Change the line that reads:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>SELINUX<span style=color:#f92672>=</span>enforcing
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>SELINUX<span style=color:#f92672>=</span>disabled
</span></span></code></pre></div><p>Save, exit, and reboot.</p><h2 id=enable-network-interfaces-on-boot>Enable Network Interfaces on Boot</h2><p>CentOS by default doesn&rsquo;t start any network interfaces on boot.  Obviously since networking is such a big part of this, we want network on boot.  In my head node, I&rsquo;ve chosen to use eth0 as my external network and eth1 as the interface internal to the network.  CentOS keeps network configuration in <code>/etc/sysconfig/network-scripts/ifconfig-[ifname]</code>, where ifname is the name of the interface (so eth0 and eth1 in this case).</p><p>So, lets edit <code>/etc/sysconfig/network-scripts/ifconfig-eth0 </code>and set it to start on boot and get its address via DHCP.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># sane-editor /etc/sysconfig/network-scripts/ifconfig-eth0</span>
</span></span></code></pre></div><p>And change:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ONBOOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;no&#34;</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ONBOOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;yes&#34;</span>
</span></span></code></pre></div><p>Now, on to eth1.  In my management network, I&rsquo;ve chosen to assign 172.16.0.1 as the floating gateway address, so that won&rsquo;t get statically assigned to an interface.  Since this is the management node, lets give it the next address in sequence - 172.16.0.2.  The following is my <code>/etc/sysconfig/network-scripts/ifconfig-eth1</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>DEVICE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;eth1&#34;</span>
</span></span><span style=display:flex><span>BOOTPROTO<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;none&#34;</span>
</span></span><span style=display:flex><span>HWADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[mac address]&#34;</span>
</span></span><span style=display:flex><span>NM_CONTROLLED<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;yes&#34;</span>
</span></span><span style=display:flex><span>ONBOOT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;yes&#34;</span>
</span></span><span style=display:flex><span>TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Ethernet&#34;</span>
</span></span><span style=display:flex><span>UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[your uuid]&#34;</span>
</span></span><span style=display:flex><span>NETWORK<span style=color:#f92672>=</span>172.16.0.0
</span></span><span style=display:flex><span>NETMASK<span style=color:#f92672>=</span>255.240.0.0
</span></span><span style=display:flex><span>IPADDR<span style=color:#f92672>=</span>172.16.0.2
</span></span><span style=display:flex><span>USERCTL<span style=color:#f92672>=</span>no
</span></span></code></pre></div><p>A few notes on this configuration:  I&rsquo;ve used the netmask for 172.16.0.0/12 because xCat will use this to try to autoset its network configuration.  I&rsquo;m going to use the /12 netmask for all statically configured IPs for just this reason.</p><p>For more on this sort of configuration, see the <a href=http://www.centos.org/docs/5/html/5.2/Deployment_Guide/s2-networkscripts-interfaces-eth0.html>CentOS page on these configurations</a>.</p><p>Now, lets bring up the interfaces and check that everything worked okay:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># ifup eth0 &amp;&amp; ifup eth1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ifconfig</span>
</span></span></code></pre></div><p>If everything went well, your eth0 should have a DHCP address, and your eth1 the address assigned to it.  Stop here and fix it if they don&rsquo;t.</p><h2 id=install-keepalived>Install Keepalived</h2><p>Unfortunately keepalivd isn&rsquo;t a core package.  In order to install keepalived, we&rsquo;ll need to set our management node up to use <a href=http://fedoraproject.org/wiki/EPEL>EPEL, the Extra Packages for Enterprise Linux</a>.  EPEL is part of fedora, a similar distribution to CentOS.  To get EPEL enabled, run the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># rpm -Uvh &#39;http://ftp.linux.ncsu.edu/pub/epel/6/i386/epel-release-6-7.noarch.rpm&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># yum update</span>
</span></span></code></pre></div><p>Okay, now you&rsquo;re ready to install keepalived:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># yum install keepalived</span>
</span></span></code></pre></div><h2 id=configure-keepalived>Configure Keepalived</h2><p>Now, lets configure keepalived.  I&rsquo;ve included my entire configuration below.  Note that if you want the two gateway nodes to have a shared external IP address, you&rsquo;ll have to set that up as well, though I haven&rsquo;t done that in this configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>! Configuration File <span style=color:#66d9ef>for</span> keepalived
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>[</span>your email<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   notification_email_from <span style=color:#f92672>[</span>some address<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   smtp_server <span style=color:#f92672>[</span>server<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>   smtp_connect_timeout <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>   router_id <span style=color:#f92672>[</span>SOME_ID<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance VI_1 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state MASTER
</span></span><span style=display:flex><span>    interface eth1
</span></span><span style=display:flex><span>    <span style=color:#75715e># This stanza added to make sure that we fall/fail over if any interface</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># goes down.  Since we&#39;re forwarding things, this would seem to make sense.</span>
</span></span><span style=display:flex><span>    track_interface <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        eth0
</span></span><span style=display:flex><span>        eth1
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>151</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#f92672>[</span>a password - typically <span style=color:#ae81ff>4</span> digits<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        172.16.0.1/12 brd 172.31.255.255 dev eth1
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span><span style=color:#e6db74>```</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>And now, lets make keepalived start on reboot:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>```</span>shell
</span></span><span style=display:flex><span><span style=color:#75715e># chkconfig --level 345 keepalived on</span>
</span></span></code></pre></div><p>and start keepalived:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># /etc/init.d/keepalived start</span>
</span></span></code></pre></div><p>And that&rsquo;s it!  Keepalived is now configured and running.  If this gateway node goes offline, another one which is running the same keepalived configuration will pick up the IP address and be the router.</p><h2 id=configuring-ip-routing>Configuring IP Routing</h2><p>This section is all about making the gateway node act properly as a gateway - that is, route traffic from an internal interface to an external one.  First, lets get rid of any IPtables rules that are laying about.  Don&rsquo;t worry, you can still add your own back in later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># iptables --flush</span>
</span></span><span style=display:flex><span><span style=color:#75715e># service iptables save</span>
</span></span></code></pre></div><p>Now, lets enable IPv4 forwarding.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># sane-editor /etc/sysctl.conf</span>
</span></span></code></pre></div><p>Find the lines that read </p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Controls IP packet forwarding</span>
</span></span><span style=display:flex><span>net.ipv4.ip_forward <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>and change them to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Controls IP packet forwarding</span>
</span></span><span style=display:flex><span>net.ipv4.ip_forward <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Now, lets reload the system configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># sysctl -p</span>
</span></span></code></pre></div><h2 id=iptables-nat-setup>IPTables NAT Setup</h2><p>Okay, now that iptables is a blank slate, lets get it set up to do <a href=http://en.wikipedia.org/wiki/NAT>NAT</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e># iptables -A FORWARD -i eth1 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#75715e># service iptables save</span>
</span></span><span style=display:flex><span><span style=color:#75715e># chkconfig --level 345 iptables on</span>
</span></span></code></pre></div><p>First, we set up a couple iptables rules, then save them, then make sure iptables is enabled to start on boot.</p><h2 id=configure-network-switches>Configure network switches</h2><p>This is a very important step - xCat will expect to have SNMP read access to the community &ldquo;public&rdquo; so it can map from switch ports to nodes.  However, because your hardware will almost certainly differ, the best I can do is refer you to you own switch&rsquo;s documentation.  In my case I&rsquo;ve set the switches up to send SNMP traps to the keepalived address.  The benefit of this is that if I&rsquo;m running dual master nodes, it will get to the right place no matter who actually holds that IP address.  However, a setup like this will introduce some complexity later in the configuration.  If you&rsquo;d rather avoid that complexity, simply set up two nodes as gateways sharing the keepalived address, but have only one run xCat and send SNMP traps to that node.</p><h2 id=miscellaneous-configuration>Miscellaneous Configuration</h2><p>This is the time to do any other configuration you&rsquo;d like.  For example, NTP, syslog, or increasing maximum parameters (per <a href=http://sumavi.com/sections/kernel-parameters>this section of the sumavi guide</a>).  In my case I&rsquo;ve only done NTP (which is somewhat outside the scope of this walkthrough), so I wont be covering them.  I also like to have the man pages handy on any machine I work on, so I install those:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># yum install man man-pages</span>
</span></span></code></pre></div><h1 id=conclusion>Conclusion</h1><p>In this section I covered rather a lot of the basic configuration of a master node - disabling SELinux, network setup, installing keepalived and making your node as a gateway.  If you&rsquo;re walking through these in sequence, now might be a good time to grab a breather and a drink.  But there will be other steps that take time and can run unattended, so hold off on that meal run!</p><p>In the next section, I&rsquo;m going to be covering actually installing xCat.</p></div></article></div></main></div></div><div id=sidebar><div class=widget><nav><h1>Recent Posts</h1><ul class=entries-reent><li><a href=https://pressers.name/2022/02/01/enigma-2022/>Enigma 2022</a></li><li><a href=https://pressers.name/2021/11/21/getting-new-lenses-lensfun-notes/>Getting new lenses for Lensfun</a></li><li><a href=https://pressers.name/2021/10/04/living-germany-converting-drivers-license/>Living in Germany: Converting a Driver's License</a></li><li><a href=https://pressers.name/2021/02/08/im-moving-germany/>I'm moving to Germany!</a></li><li><a href=https://pressers.name/2021/01/23/i-finally-finished-kings-quest-6/>I Finally Finished King's Quest 6!</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Social Media</h1><ul class=socialmedia><li><a href=https://twitter.com/spresser>Twitter</a></li><li><a href=https://www.linkedin.com/in/steven-presser/>LinkedIn</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Categories</h1><ul class=categories><li><a href=https://pressers.name/categories/3d-printing/>3D Printing</a></li><li><a href=https://pressers.name/categories/acm/>ACM</a></li><li><a href=https://pressers.name/categories/acm-cluster/>ACM Cluster</a></li><li><a href=https://pressers.name/categories/cyberlaw/>Cyberlaw</a></li><li><a href=https://pressers.name/categories/cybersecurity/>Cybersecurity</a></li><li><a href=https://pressers.name/categories/germany/>Germany</a></li><li><a href=https://pressers.name/categories/infrastructure/>Infrastructure</a></li><li><a href=https://pressers.name/categories/life-in-germany/>Life in Germany</a></li><li><a href=https://pressers.name/categories/links/>Links</a></li><li><a href=https://pressers.name/categories/presentations/>Presentations</a></li><li><a href=https://pressers.name/categories/projects/>Projects</a></li><li><a href=https://pressers.name/categories/shrubbery/>Shrubbery</a></li></ul></nav></div><div class=sidebarbender></div></div></div><div id=onetracebottom><footer><a href=https://github.com/spresse1/pressers.name>Website source</a><br>Site design by Kyle M.</footer></div></div></body></html>