<!doctype html><html lang=en><head><title>Configuring Cisco 2900XL Switches via TFTP (and alongside xCat) - The Electronic Press</title><meta charset=utf-8><meta http-equiv=cache-control content="public"><meta name=robots content="follow, all"><meta name=language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="As part of my ACM cluster creation obsession, I wanted to make the Cisco 2900XL switches we have autoconfigure. I&rsquo;m not terribly familiar with how these switches operate and, rather than reconfigure all of them at once, I&rsquo;d much rather be able to reboot (reload, in cisco parlence) them and have them come up with my new, clean config.
Fortunately for me, Cisco thought of a situation like this when building the software for these switches."><meta name=keywords content><link rel=alternate type=application/rss+xml title="RSS Feed for pressers.name" href=/index.xml><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/base.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/cssmenu.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/menustyling.css><link rel=stylesheet type=text/css media="screen, projection" href=/static/css/blog.css><link rel=stylesheet type=text/css media=print href=/static/css/print.css></head><body><div id=skip><a href=#content>Skip to Main Content</a></div><div id=leftbar></div><div id=contentwrapper><div id=header><div id=titleimagediv></div><div id=twotraces><div id=twotracesright>&nbsp;</div></div></div><div class=menu id=topmenu><nav><ul class=top-navigation><li><a href=/ title=Home rel=home>Home</a></li><li><a href=http://github.com/spresse1>GitHub</a></li><li><a href=/contact>Contact</a></li></ul></nav></div><div id=onetrace><div id=onetraceleft></div><div id=breadcrumbs class=breadcrumbs><nav><ul class=breadcrumbs><li><a href=/>Home</a></li><li><a href=/blog/>Blogs</a></li><li><a href=/2012/09/11/configuring-cisco-2900xl-switches-tftp-and-alongside-xcat/>Configuring Cisco 2900XL Switches via TFTP (and alongside xCat)</a></li></ul></nav></div></div><div id=bodywrapper><div id=content><div id=contentborder></div><div id=innercontent><main><div class=hentry><article itemtype=http://schema.org/Article itemscope id=blog/acm-cluster/configuring-cisco-2900xl-switches-tftp-and-alongside-xcat.md><header class=entry-header><h1 class=entry-title><a href=/2012/09/11/configuring-cisco-2900xl-switches-tftp-and-alongside-xcat/>Configuring Cisco 2900XL Switches via TFTP (and alongside xCat)</a></h1><p class=entry-info>Published on <time>Tue, Sep 11, 2012</time>
in ACM, ACM Cluster</p></header><div class=entry-body><p>As part of my ACM cluster creation obsession, I wanted to make the Cisco 2900XL switches we have autoconfigure.  I&rsquo;m not terribly familiar with how these switches operate and, rather than reconfigure all of them at once, I&rsquo;d much rather be able to reboot (reload, in cisco parlence) them and have them come up with my new, clean config.</p><p>Fortunately for me, Cisco thought of a situation like this when building the software for these switches.  According to <a href=http://www.cisco.com/en/US/docs/switches/lan/catalyst2900xl_3500xl/release12.0_5_wc5/swg/swsyst.html#wp1028392>this page from their instruction manual</a>, if a switch boots and doesn&rsquo;t have an in-flash configuration file, it will DHCP/BOOTP for a network address, then attempt to TFTP one of several files - network-confg, cisconet.cfg, router-confg or ciscortr.cfg.</p><p>In my case, I&rsquo;m running this next to xCat, so I already have a TFTP and DHCP servers running.  Furthermore, my switch was already set up in xCat to get a static address.  So all I really needed to do was put in the configuration file.  But how to generate one&mldr;</p><h1 id=generating-a-cisco-config>Generating a Cisco Config</h1><p>I chose to make my configuration file from the running configuration on my switches.  This seemed the simplest thing to do - get everything working as I wanted it, then save that configuration.  So here is how to get the running config from a Cisco switch:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Switch&gt;enable
</span></span><span style=display:flex><span>Switch#show running-config 
</span></span><span style=display:flex><span>Building configuration...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Current configuration:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>output truncated<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>You should be able to copy-paste this to one of the files I mentioned above (I used cisconet.cfg), remove any switch-specific information (specifically the IP address) and put it in the root tftp directory (/tftpboot, in my case).  The switches will then be able to self-configure using it.</p><h1 id=configuring-a-switch-to-use-dhcp-configuration>Configuring a switch to use DHCP configuration</h1><p>The Cisco switches prefer local configuration over remote configuration.  The best way to make them fully configurable via the network is to completely remove all local configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Switch&gt;enable
</span></span><span style=display:flex><span>Switch#dir
</span></span><span style=display:flex><span>Directory of flash:/
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>  -rwx     <span style=color:#ae81ff>1644046</span>   Apr <span style=color:#ae81ff>04</span> <span style=color:#ae81ff>2000</span> 00:29:33  c2900XL-c3h2s-mz-120.5-XU.bin
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>3</span>  -rwx      <span style=color:#ae81ff>105961</span>   Apr <span style=color:#ae81ff>04</span> <span style=color:#ae81ff>2000</span> 00:29:33  c2900XL-diag-mz-120.5-XU
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>4</span>  drwx        <span style=color:#ae81ff>6784</span>   Apr <span style=color:#ae81ff>04</span> <span style=color:#ae81ff>2000</span> 00:29:34  html
</span></span><span style=display:flex><span><span style=color:#ae81ff>111</span>  -rwx         <span style=color:#ae81ff>286</span>   Jan <span style=color:#ae81ff>01</span> <span style=color:#ae81ff>1970</span> 00:00:14  env_vars
</span></span><span style=display:flex><span><span style=color:#ae81ff>112</span>  -rwx         <span style=color:#ae81ff>660</span>   Mar <span style=color:#ae81ff>01</span> <span style=color:#ae81ff>1993</span> 01:41:16  vlan.da
</span></span><span style=display:flex><span>t114  -rwx        <span style=color:#ae81ff>2961</span>   May <span style=color:#ae81ff>11</span> <span style=color:#ae81ff>1993</span> 22:58:01  config.text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3612672</span> bytes total <span style=color:#f92672>(</span><span style=color:#ae81ff>833024</span> bytes free<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Switch#delete config.text
</span></span><span style=display:flex><span>Switch#reload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>System configuration has been modified. Save? <span style=color:#f92672>[</span>yes/no<span style=color:#f92672>]</span>: no
</span></span><span style=display:flex><span>Proceed with reload? <span style=color:#f92672>[</span>confirm<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>This block removes the active configuration and reboots the switch.  Now lets watch the xCat logs to make sure everything happens as we expect:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># tail -f /var/log/messages</span>
</span></span><span style=display:flex><span>Sep <span style=color:#ae81ff>13</span> 15:49:11 cluster dhcpd: DHCPDISCOVER from 00:02:b9:94:20:c0 via eth1
</span></span><span style=display:flex><span>Sep <span style=color:#ae81ff>13</span> 15:49:11 cluster dhcpd: DHCPOFFER on 172.16.0.5 to 00:02:b9:94:20:c0 via eth1
</span></span><span style=display:flex><span>Sep <span style=color:#ae81ff>13</span> 15:49:11 cluster dhcpd: DHCPREQUEST <span style=color:#66d9ef>for</span> 172.16.0.5 <span style=color:#f92672>(</span>172.16.0.2<span style=color:#f92672>)</span> from 00:02:b9:94:20:c0 via eth1
</span></span><span style=display:flex><span>Sep <span style=color:#ae81ff>13</span> 15:49:11 cluster dhcpd: DHCPACK on 172.16.0.5 to 00:02:b9:94:20:c0 via eth1
</span></span><span style=display:flex><span>Sep <span style=color:#ae81ff>13</span> 15:49:14 cluster in.tftpd<span style=color:#f92672>[</span>20563<span style=color:#f92672>]</span>: RRQ from 172.16.0.5 filename eth-switch1.cfg
</span></span><span style=display:flex><span>Sep <span style=color:#ae81ff>13</span> 15:49:14 cluster in.tftpd<span style=color:#f92672>[</span>20564<span style=color:#f92672>]</span>: RRQ from 172.16.0.5 filename eth-switch1.cfg
</span></span></code></pre></div><p>Yes, it spits out rather a lot of junk.  In any case, it takes the switch about 1.5 minutes to completely reboot and if you see these messages in your log, you&rsquo;re all set.</p><h1 id=fetching-config-via-tftp>Fetching Config via TFTP</h1><p>One thing I thought would be particularly nice for this setup was the ability to get the configuration of the switches via the network.  The cisco <a href=http://www.cisco.com/en/US/docs/switches/lan/catalyst2900xl_3500xl/release12.0_5_wc5/swg/swsyst.html#wp1028392>2900xl manual</a> mentions the ability to do this, but I needed to get it to work with xCat.  In order to do this, I needed to specify files that DHCP should instruct the switch to download.  XCat doesn&rsquo;t seem to have a way to do this in the table format (though I&rsquo;d love to be wrong about this).  However, the makedhcp man page says:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>       <span style=color:#f92672>[</span>-s statements<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                   For the input noderange, the argument will be interpreted
</span></span><span style=display:flex><span>                   like dhcp configuration file text.
</span></span></code></pre></div><p>Which lets me do exactly what I want.  Best of all, this data is preserved over all makedhcp operations, until I again specify a -s option.  So I ran the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>makedhcp eth-switch1 -s <span style=color:#960050;background-color:#1e0010>&#39;</span>supersede server.filename <span style=color:#f92672>=</span> <span style=color:#ae81ff>\&#34;</span>eth-switch1.cfg<span style=color:#ae81ff>\&#34;</span>; supersede server.next-server <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>Hex encoded address of tftp server<span style=color:#f92672>]</span>;
</span></span></code></pre></div><p>And thats it!  Now when I boot this switch, it fetches the eth-switch1.cfg file from my tftp server and uses that to self-configure.</p></div></article></div></main></div></div><div id=sidebar><div class=widget><nav><h1>Recent Posts</h1><ul class=entries-reent><li><a href=/2022/04/03/website-hosting-changed/>Website hosting changed</a></li><li><a href=/2022/02/01/enigma-2022/>Enigma 2022</a></li><li><a href=/2021/11/21/getting-new-lenses-lensfun-notes/>Getting new lenses for Lensfun</a></li><li><a href=/2021/10/04/living-germany-converting-drivers-license/>Living in Germany: Converting a Driver's License</a></li><li><a href=/2021/02/08/im-moving-germany/>I'm moving to Germany!</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Social Media</h1><ul class=socialmedia><li><a href=https://twitter.com/spresser>Twitter</a></li><li><a href=https://www.linkedin.com/in/steven-presser/>LinkedIn</a></li></ul></nav></div><div class=sidebarbender></div><div class=widget><nav><h1>Categories</h1><ul class=categories><li><a href=/categories/3d-printing/>3D Printing</a></li><li><a href=/categories/acm/>ACM</a></li><li><a href=/categories/acm-cluster/>ACM Cluster</a></li><li><a href=/categories/cyberlaw/>Cyberlaw</a></li><li><a href=/categories/cybersecurity/>Cybersecurity</a></li><li><a href=/categories/germany/>Germany</a></li><li><a href=/categories/infrastructure/>Infrastructure</a></li><li><a href=/categories/life-in-germany/>Life in Germany</a></li><li><a href=/categories/links/>Links</a></li><li><a href=/categories/presentations/>Presentations</a></li><li><a href=/categories/projects/>Projects</a></li><li><a href=/categories/shrubbery/>Shrubbery</a></li></ul></nav></div><div class=sidebarbender></div></div></div><div id=onetracebottom><footer><a href=https://github.com/spresse1/pressers.name>Website source</a><br>Site design by Kyle M.</footer></div></div></body></html>